// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// Employee/User master table
model User {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username   String   @unique @db.VarChar(50)
  password   String   @db.VarChar(255) // Hashed password using bcrypt
  email      String   @unique @db.VarChar(100)
  fullName   String   @map("full_name") @db.VarChar(100)
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  userRoles         UserRole[]      @relation("UserToUserRoles")
  assignedRoles     UserRole[]      @relation("AssignedByUser")
  sessions          UserSession[]

  @@index([username])
  @@index([email])
  @@map("users")
}

// Role/Position master table
model Role {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleName    String   @unique @map("role_name") @db.VarChar(50)
  roleCode    String   @unique @map("role_code") @db.VarChar(20) // Unique code like: ADMIN, MGR_HRD, STAFF_IT
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  userRoles       UserRole[]
  menuAccess      RoleMenuAccess[]
  sessions        UserSession[]

  @@index([roleCode])
  @@map("roles")
}

// Many-to-many relationship table between users and roles
model UserRole {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  roleId     String    @map("role_id") @db.Uuid
  isDefault  Boolean   @default(false) @map("is_default") // Default role selected on login
  assignedAt DateTime  @default(now()) @map("assigned_at") @db.Timestamp(6)
  assignedBy String?   @map("assigned_by") @db.Uuid // User who assigned this role

  // Relations
  user           User  @relation("UserToUserRoles", fields: [userId], references: [id], onDelete: Cascade)
  role           Role  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedByUser User? @relation("AssignedByUser", fields: [assignedBy], references: [id], onDelete: SetNull)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// Menu master table with hierarchical structure (unlimited levels)
model Menu {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  parentId   String?  @map("parent_id") @db.Uuid // NULL if root/main menu
  menuName   String   @map("menu_name") @db.VarChar(100)
  menuCode   String   @unique @map("menu_code") @db.VarChar(50) // Unique code like: DASHBOARD, USER_MGMT
  menuUrl    String?  @map("menu_url") @db.VarChar(255) // Path/route for frontend
  menuIcon   String?  @map("menu_icon") @db.VarChar(50) // Icon class or icon name
  menuOrder  Int      @default(0) @map("menu_order") // Display order
  menuLevel  Int      @default(1) @map("menu_level") // Depth level
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  parent     Menu?            @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children   Menu[]           @relation("MenuHierarchy")
  roleAccess RoleMenuAccess[]

  @@index([parentId])
  @@index([menuCode])
  @@index([menuOrder])
  @@map("menus")
}

// Role-menu access mapping table with CRUD permissions
model RoleMenuAccess {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId    String   @map("role_id") @db.Uuid
  menuId    String   @map("menu_id") @db.Uuid
  canView   Boolean  @default(true) @map("can_view")
  canCreate Boolean  @default(false) @map("can_create")
  canUpdate Boolean  @default(false) @map("can_update")
  canDelete Boolean  @default(false) @map("can_delete")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([roleId, menuId])
  @@index([roleId])
  @@index([menuId])
  @@map("role_menu_access")
}

// Session tracking table with JWT tokens
model UserSession {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  roleId       String   @map("role_id") @db.Uuid // Selected role on login
  token        String   @db.Text // JWT token
  refreshToken String?  @map("refresh_token") @db.Text // Token for JWT refresh
  ipAddress    String?  @map("ip_address") @db.VarChar(45) // IPv4 or IPv6
  userAgent    String?  @map("user_agent") @db.Text // Browser/device info
  expiresAt    DateTime @map("expires_at") @db.Timestamp(6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}
